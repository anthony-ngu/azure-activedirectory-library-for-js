// @preserve Copyright (c) Microsoft Open Technologies, Inc.
"use strict";"undefined"!=typeof module&&module.exports&&(module.exports.inject=function(e){return new AuthenticationContext(e)}),function(){if(angular){var e=angular.module("AdalAngular",[]);e.provider("adalAuthenticationService",function(){var e=null,r={isAuthenticated:!1,userName:"",loginError:"",profile:""},n=null,o=function(n){var o=e.getCachedToken(n);r.isAuthenticated=null!==o&&o.length>0;var t=e.getCachedUser()||{userName:""};r.userName=t.userName,r.profile=t.profile,r.loginError=e.getLoginError()};this.init=function(r,t){if(!r)throw Error("You must set configOptions, when calling init");var i=window.location.hash,a=window.location.href;if(i&&(a=a.replace(i,"")),r.redirectUri=r.redirectUri||a,r.postLogoutRedirectUri=r.postLogoutRedirectUri||a,t&&t.interceptors&&t.interceptors.push("ProtectedResourceInterceptor"),r.isOffline&&"function"!=typeof r.isOffline)throw Error("callback isOnline is not a function");n=r.isOffline,e=new AuthenticationContext(r),o(e.config.loginResource)},this.$get=["$rootScope","$window","$q","$location","$timeout","$injector",function(t,i,a,c,u,s){function l(e,r){return r.requireADLogin?e.requireADLogin!==!1:!!e.requireADLogin}var f=function(){var a=i.location.hash;if(e.isCallback(a)){var l=e.getRequestInfo(a);if(e.saveTokenFromHash(l),c.$$html5?i.location=i.location.origin+i.location.pathname:i.location.hash="",l.requestType!==e.REQUEST_TYPE.LOGIN&&(e.callback=i.parent.AuthenticationContext().callback,l.requestType===e.REQUEST_TYPE.RENEW_TOKEN&&(e.callback=i.parent.callBackMappedToRenewStates[l.stateResponse])),l.stateMatch)if("function"==typeof e.callback){if(l.requestType===e.REQUEST_TYPE.RENEW_TOKEN){if(l.parameters.access_token)return void e.callback(e._getItem(e.CONSTANTS.STORAGE.ERROR_DESCRIPTION),l.parameters.access_token);if(l.parameters.id_token)return void e.callback(e._getItem(e.CONSTANTS.STORAGE.ERROR_DESCRIPTION),l.parameters.id_token)}}else o(e.config.loginResource),r.userName?(u(function(){o(e.config.loginResource),t.userInfo=r;var n=e._getItem(e.CONSTANTS.STORAGE.START_PAGE);if(n){var i=e._getItem(e.CONSTANTS.STORAGE.START_PAGE_PARAMS);if(i){var a=JSON.parse(i);c.url(n).search(a)}else c.url(n)}},1),t.$broadcast("adal:loginSuccess",e.config.loginResource)):t.$broadcast("adal:loginFailure",e._getItem(e.CONSTANTS.STORAGE.ERROR_DESCRIPTION),e.config.loginResource);else t.$broadcast("adal:stateMismatch",e._getItem(e.CONSTANTS.STORAGE.ERROR_DESCRIPTION))}else{if(n&&n(s))return void e.warn("Location change event ignore due to app state offline.");o(e.config.loginResource),r.isAuthenticated||!r.userName||e._renewActive||(e._renewActive=!0,e.acquireToken(e.config.loginResource,function(n,o){e._renewActive=!1,n?t.$broadcast("adal:loginFailure","auto renew failure",e.config.loginResource):o&&(r.isAuthenticated=!0,t.$broadcast("adal:loginSuccess",e.config.loginResource))}))}u(function(){o(e.config.loginResource),t.userInfo=r},1)},g=function(){e.info("Login event for:"+c.$$url),e.config&&e.config.localLoginUrl?c.path(e.config.localLoginUrl):(e._saveItem(e.CONSTANTS.STORAGE.START_PAGE,c.$$url),e.info("Start login at:"+window.location.href),t.$broadcast("adal:loginRedirect"),e.login())},d=function(n,o){o&&o.$$route&&l(o.$$route,e.config)&&(r.isAuthenticated||e._renewActive||(e.info("Route change event for:"+c.$$url),g()))},R=function(n,o,t){o&&l(o,e.config)&&(r.isAuthenticated||e._renewActive||(c.$$url=o.url,e._saveItem(e.CONSTANTS.STORAGE.START_PAGE_PARAMS,JSON.stringify(t)),e.info("State change event for:"+c.$$url),g()))};return t.$on("$routeChangeStart",d),t.$on("$stateChangeStart",R),t.$on("$locationChangeStart",f),o(e.config.loginResource),t.userInfo=r,{config:e.config,login:function(){e.login()},loginInProgress:function(){return e.loginInProgress()},logOut:function(){e.logOut()},getCachedToken:function(r){return e.getCachedToken(r)},userInfo:r,acquireToken:function(r){var n=a.defer(),t=r===e.config.loginResource;return e._renewActive=t?!0:e._renewActive,e.acquireToken(r,function(i,a){e._renewActive=t?!1:e._renewActive,i?(e.error("Error when acquiring token for resource: "+r,i),n.reject(i)):(t&&o(e.config.loginResource),n.resolve(a))}),n.promise},getUser:function(){var r=a.defer();return e.getUser(function(n,o){n?(e.error("Error when getting user",n),r.reject(n)):r.resolve(o)}),r.promise},getResourceForEndpoint:function(r){return e.getResourceForEndpoint(r)},clearCache:function(){e.clearCache()},clearCacheForResource:function(r){e.clearCacheForResource(r)},info:function(r){e.info(r)},verbose:function(r){e.verbose(r)}}}]}),e.factory("ProtectedResourceInterceptor",["adalAuthenticationService","$q","$rootScope",function(e,r,n){return{request:function(n){if(n){n.headers=n.headers||{};var o=e.getResourceForEndpoint(n.url);if(null===o)return n;var t=e.getCachedToken(o);if(t)return e.info("Token is avaliable for this url "+n.url),n.headers.Authorization="Bearer "+t,n;if(e.loginInProgress())return e.info("login already start."),r.reject("login in progress, cancelling the request");var i=r.defer();return e.acquireToken(o).then(function(r){e.verbose("Token is avaliable"),n.headers.Authorization="Bearer "+r,i.resolve(n)},function(e){i.reject(e)}),i.promise}},responseError:function(o){if(e.info("Getting error in the response"),o){if(401===o.status){var t=e.getResourceForEndpoint(o.config.url);e.clearCacheForResource(t),n.$broadcast("adal:notAuthorized",o,t)}else n.$broadcast("adal:errorResponse",o);return r.reject(o)}}}}])}else console.error("Angular.JS is not included")}();